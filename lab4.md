University: ITMO University

Faculty: ICT

Course: Network programming

Year: 2022/2023

Group: K34212

Author: Sorokina Irina

Lab4

Цель работы

Изучить синтаксис языка программирования P4 и выполнить 2 задания обучающих задания от Open network foundation для ознакомления на практике с P4.

Ход работы

Склонировала репозиторий p4lang/tutorials и установила Vagrant с помощью VPN. После обновления VirtualBox перешла в папку «cd vm-ubuntu-20.04» и используя Vagrant развернула тестовую среду vagrant up. В результате установки появилась виртуальная машина с аккаунтами login/password vagrant/vagrant и p4/p4.

![image](https://user-images.githubusercontent.com/58992611/212840157-30ffb404-f3b0-42b9-80bc-975837acb212.png)

Basic Forwarding

Схема связи:

![image](https://user-images.githubusercontent.com/58992611/212840232-a9633fbe-f3b6-4331-995d-d8cb7d27100c.png)

Запустила файл basic.p4, чтобы проверить его поведение. Для этого включила переключатель в Mininet с помощью команды «make run», после этого увидела командную строку Mininet. Пинг не проходит между хостами в системе. Вышла из командной строки Mininet и остановила Mininet.

![image](https://user-images.githubusercontent.com/58992611/212840357-4c6f48d5-4fd2-4f0a-ad5d-f623f0b45cdd.png)

Отредактировала PARSER:

Парсер предназначен для преобразования данных из поступающих пакетов в читаемые данные. 

При получении Ethernet-пакета наступает состояние «start», после чего парсер переходит в состояние обработки пакета. Для этого добавила состояния «parse_ethernet», в котором извлекается Ethernet заголовок и «parse_ipv4», извлекающий IPv4 заголовок из пакета.

![image](https://user-images.githubusercontent.com/58992611/213074601-8e30e28c-345e-4755-be43-cfe29f1df727.png)

Отредактировала Ingress Processing:

Раздел Ingress Processing содержит методы, необходимые для обработки пакета на плане управления. 

Дополнила метод, отвечающий за передачу пакетов (функция MyIngress).

Добавила логику пересылки пакетов:

•	на порт выхода назначается число, переданное в метод 

•	Ethernet адрес назначения заменяется на новый

•	Ethernet адрес источника заменяется на предыдущий адрес назначения

•	уменьшается значение TTL

Определила таблицу (table ipv4_lpm), которая читает адрес назначения и вызывает одно из трех действий: сбросить пакет, передать пакет и ничего не делать (действие по умолчанию).

Применяем таблицу, если заголовок ipv4 правильный (проверка правильности IP-адреса).

![image](https://user-images.githubusercontent.com/58992611/213074734-9f35134f-f101-4e6c-a6c3-36da62364874.png)

Отредактировала DEPARSER:

Депарсер отвечает за обратное преобразование пакетов в данные, понятные машине. 

Сперва преобразуем Ethernet-пакет, а после этого - IPv4-пакет.

![image](https://user-images.githubusercontent.com/58992611/213074790-92a1eb5d-546f-42d6-aa72-c96969a0833a.png)

Затем снова запустила Mininet и пробовала пинг между хостами. Можно наблюдать, что пинги успешно проходят.

![image](https://user-images.githubusercontent.com/58992611/212840523-ba14637c-c91c-4af2-b4e4-aa6804a1b8b3.png)

Basic Tunneling

Схема связи:

![image](https://user-images.githubusercontent.com/58992611/212840605-c1eebe02-6ad8-4977-b1aa-9010067c42c5.png)

Теперь необходимо добавить поддержку базового протокола туннелирования на основе предыдущего задания. 
Зашла в директорию ~/tutorials/exercises/basic_tunnel и внесла изменения в файл basick_tunnel.p4. 

Для начала добавила новый тип заголовка «myTunnel_t». Он содержит два 16-битных поля: «proto_id» и «dst_id».

![image](https://user-images.githubusercontent.com/58992611/213074958-864a287a-9f80-4098-866b-a13e102cdf1b.png)

Отредактировала PARSER:

В парсер было добавлено новое состояние (parse_myTunnel), преобразующее туннельный заголовок. 

Если идентификатор протокола соответствует IPv4 (зависит от значения поля «etherType» в заголовке Ethernet), парсер переходит в состояние преобразования IP-пакета по умолчанию - просто принимает пакет. Иначе, извлекается заголовок «myTunnel».

![image](https://user-images.githubusercontent.com/58992611/213075026-8af5a3bb-ffd7-40f0-9bca-e4761a7094cf.png)

Отредактировала Ingress Processing:

В этом разделе добавила функцию «myTunnel_forward», которая перенаправляет пакет на нужный порт и новую таблицу (myTunnel_exact), в которой будут храниться записи о маршрутах туннелирования. В качестве ключа таблица ищет точное соответствие для «dest_id» и, в случае если точное соответствие найдено, вызывает функцию «myTunnel_forward». 

Обновила функция «apply» таким образом, чтобы она могла вызывать таблицу «myTunnel_exact», или «ipv4_lpm» при необходимости. Прописала условия проверки - если IP задан верно, а туннель нет, то отправляем пакеты обычным способом, а если всё задано верно, то - через туннель.

![image](https://user-images.githubusercontent.com/58992611/213075070-05d575d8-d657-4060-a524-805f404aefaf.png)

Отредактировала DEPARSER:

Добавила в депарсер пакеты туннелирования. Они преобразуются после Ethernet, но перед IPv4-пакетами.

![image](https://user-images.githubusercontent.com/58992611/213075123-855cfe9d-24c4-4e11-bdb3-5ab7c4d751bc.png)

Далее в Minilet выполнила команду «xterm h1 h2». В результате были открыты два терминала:

![image](https://user-images.githubusercontent.com/58992611/212840673-07b2e578-0592-4be9-aeb0-d1e7d91bd004.png)

На хосте h2 подняла сервер командой «./receive.py».
На h1 была выполнена команда «./send.py 10.0.2.2 "P4 is cool"» для отправки сообщения хосту h2 пакета без туннелирования, но с указанием ip адреса получателя. Видим, что итоговый пакет успешно дошел до адресата. Он содержит заголовки TCP, Ethernet, IPv4 и само переданное сообщение.

![image](https://user-images.githubusercontent.com/58992611/212840719-6143575f-3dff-4c02-9607-c3b84e0de25f.png)

Затем с хоста h1 отправила хосту h2 туннелированный пакет на IP-адрес третьего коммутатора, при этом указав "dst_id" второго коммутатора. В этом случае IP адрес не важен, важен только id назначения. Пакет не дошел до отправителя и ушел на второй коммутатор, потому что коммутатор больше не использует заголовок IP для маршрутизации, когда заголовок "MyTunnel" находится в пакете.

![image](https://user-images.githubusercontent.com/58992611/212840782-b6ed6367-ada4-41c0-90fc-52630e3b69f9.png)

Вывод:

В ходе выполнения лабораторной работы была создана виртуальная машина и изучены основы синтаксиса языка программирования P4. Выполнила 2 программы, где было детально разобрано стандартное перенаправление пакетов, а также туннелирование.
